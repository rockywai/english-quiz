<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE è‹±æ–‡è©å½™è‡ªå­¸ç³»çµ± V6.0 (Accordion + Highlight)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #f5a623;
            --bg: #f4f7f6;
            --text: #333;
            --card-bg: #ffffff;
            --highlight: #ffeeba; /* é«˜äº®é¡è‰² */
            --danger: #e74c3c;
            --success: #2ecc71;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 95vh; /* é™åˆ¶é«˜åº¦è®“å…§éƒ¨æ»¾å‹• */
        }

        /* å°èˆªæ¬„ */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            flex-shrink: 0;
        }
        
        .nav-title { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .home-btn { cursor: pointer; font-size: 1.2rem; }

        /* æ»¾å‹•å€åŸŸ */
        .scroll-content {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 5px;
        }

        /* é¦–é ï¼šæ‘ºç–Šé¸å–®æ¨£å¼ */
        .news-group { margin-bottom: 15px; }
        
        .group-header {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            transition: all 0.2s;
        }

        .group-header:hover { background: #f8f9fa; border-color: var(--primary); }
        .group-header::after { content: 'â–¼'; font-size: 0.8rem; color: #888; }
        .group-header.active::after { content: 'â–²'; }
        .group-header.active { background: #eef6ff; border-color: var(--primary); color: var(--primary); }

        .group-content {
            display: none; /* é è¨­éš±è— */
            padding: 10px 0 0 10px;
            animation: fadeIn 0.3s;
        }
        .group-content.show { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .level-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .level-card:hover { transform: translateX(5px); }
        .level-card.done { border-left-color: var(--success); }

        /* æ–‡ç« é¡¯ç¤ºå€ (ç½®é ‚èˆ‡é«˜äº®) */
        .article-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.8;
            font-size: 1rem;
            color: #444;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .highlight-word {
            background-color: var(--highlight);
            border-bottom: 2px solid var(--secondary);
            cursor: pointer;
            padding: 0 2px;
            font-weight: bold;
            color: #000;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .highlight-word:hover { background-color: #ffd700; }

        /* è©å½™å¡èˆ‡æ¸¬é©— */
        .word-card {
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .option-btn {
            background: white;
            border: 2px solid #eee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        .option-btn:hover { border-color: var(--primary); background: #f0f7ff; }
        .option-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .option-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        /* æ’è¡Œæ¦œ Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; height: 80%;
            border-radius: 12px; padding: 20px;
            display: flex; flex-direction: column;
        }
        .close-btn { align-self: flex-end; cursor: pointer; font-size: 1.5rem; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="nav-bar" class="nav-bar hidden">
        <div class="home-btn" onclick="goHome()">ğŸ  Home</div>
        <div id="nav-title" class="nav-title">Topic</div>
    </div>

    <div class="scroll-content">

        <div id="home-screen" class="screen">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary);">ğŸ‡¬ğŸ‡§ DSE è‹±æ–‡è©å½™è‡ªå­¸</h2>
                <div id="student-display" style="background:#eee; padding:8px 15px; border-radius:20px; display:inline-block; cursor:pointer;" onclick="editName()">
                    ğŸ‘¤ æœªçŸ¥å­¸ç”Ÿ (é»æ“Šä¿®æ”¹)
                </div>
            </div>

            <div id="news-container">
                </div>

            <button onclick="openLeaderboard()" 
                    style="margin-top: 20px; background: var(--secondary); border:none; padding:12px; width:100%; color:white; border-radius:8px; cursor:pointer; font-weight:bold;">
                ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ (Leaderboard)
            </button>
        </div>

        <div id="study-screen" class="screen hidden">
            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">ğŸ’¡ é»æ“Šé»ƒè‰²å–®å­—å¯è†è½ç™¼éŸ³</div>
            <div id="article-display" class="article-box">
                </div>

            <div id="study-mode-content">
                <h3 style="border-left:4px solid var(--primary); padding-left:10px;">é‡é»è©å½™</h3>
                <div id="vocab-list"></div>
                <button class="primary-btn" onclick="startQuiz()">æº–å‚™å¥½äº†ï¼Œé–‹å§‹æ¸¬é©—ï¼</button>
            </div>

            <div id="quiz-mode-content" class="hidden">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-weight:bold;">
                    <span id="quiz-progress">Q 1/5</span>
                    <span id="quiz-score">Score: 0</span>
                </div>
                <h2 id="quiz-question" style="text-align:center; font-size:1.8rem; margin:20px 0; color:var(--primary);">Word</h2>
                <div id="quiz-options"></div>
                <div id="feedback-msg" style="text-align:center; height:20px; font-weight:bold; margin-top:10px;"></div>
            </div>
        </div>

        <div id="result-screen" class="screen hidden" style="text-align:center; padding-top:30px;">
            <h2>æ¸¬é©—å®Œæˆï¼</h2>
            <div id="final-score" style="font-size:3rem; font-weight:bold; color:var(--primary); margin:10px 0;">5/5</div>
            <p id="result-comment">åšå¾—å¥½ï¼</p>
            <div id="upload-status" style="margin:20px 0; color:#666;">â³ æ­£åœ¨åŒæ­¥æˆç¸¾...</div>
            <button class="primary-btn" onclick="goHome()">è¿”å›ä¸»é </button>
        </div>

    </div>
</div>

<div id="leaderboard-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="close-btn" onclick="closeLeaderboard()">Ã—</div>
        <h3 style="text-align:center; margin-top:0;">ğŸ† æ’è¡Œæ¦œ</h3>
        <iframe id="lb-frame" src="" style="width:100%; height:100%; border:none; background:#f9f9f9;"></iframe>
        <div style="text-align:center; margin-top:10px;">
            <a id="lb-link" href="#" target="_blank" style="font-size:0.9rem;">ç„¡æ³•é¡¯ç¤ºï¼Ÿé»æ­¤é–‹å•Ÿ</a>
        </div>
    </div>
</div>

<script>
    // ============================================
    // âš™ï¸ è¨­å®šå€
    // ============================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxsyiIpzJOZ1kivi-o2DHh9CTk3Yttfh2EjTTKsUvIWZcDiefCk6sPfNy6MpnJZf41atg/exec"; 
    const LEADERBOARD_URL = "https://docs.google.com/spreadsheets/d/1aF_kOYACbtaPKiFsqejyPDUQMiQskqNhtiElzIfkH6o/edit?gid=103466806#gid=103466806"; // è«‹å¡«å…¥ä½  Google Sheet çš„åˆ†äº«é€£çµ
    // ============================================


    // --- è³‡æ–™åº« ---
    const newsGroups = [
        {
            topic: "26.01.2026 A Farm Helps People Eat Well",
            levels: [
                {
                    id: "farm-lv1", level: "DSE LV1 (Basic)",
                    content: "A farm in the UK is helping people to eat better. Many people do not know how to cook fresh food. They usually buy ready meals from shops. The farm shows them how to grow vegetables and prepare healthy meals. It is important to eat fresh food for our bodies. One woman said she feel much better now. This project makes a big difference in the community. Everyone learns to enjoy cooking together.",
                    vocab: [
                        { w: "cook", pos: "v.", cn: "çƒ¹é£ª" },
                        { w: "healthy", pos: "adj.", cn: "å¥åº·çš„" },
                        { w: "bodies", pos: "n.", cn: "èº«é«”" },
                        { w: "difference", pos: "n.", cn: "æ”¹è®Š/å½±éŸ¿" },
                        { w: "enjoy", pos: "v.", cn: "äº«å—" }
                    ]
                },
                {
                    id: "farm-lv2", level: "DSE LV2-3 (Intermediate)",
                    content: "A unique farm project in the UK is tackling the issue of poor nutrition. Many residents rely on processed foods because they lack the skills to cook from scratch. The farm provides a solution by teaching people how to cultivate their own vegetables. This experience encourages participants to move away from unhealthy eating habits. Organisers believe that understanding where food comes from is essential for improving public health. As people learn to prepare fresh ingredients, they become more independent.",
                    vocab: [
                        { w: "rely", pos: "v.", cn: "ä¾è³´" },
                        { w: "solution", pos: "n.", cn: "è§£æ±ºæ–¹æ³•" },
                        { w: "experience", pos: "n.", cn: "ç¶“é©—/é«”é©—" },
                        { w: "improving", pos: "v.", cn: "æ”¹å–„" },
                        { w: "independent", pos: "adj.", cn: "ç¨ç«‹çš„" }
                    ]
                },
                {
                    id: "farm-lv3", level: "DSE LV4-5 (Advanced)",
                    content: "The sustainability of urban diets has become a major concern, prompting a British farm to launch an educational initiative. This project targets individuals who have become overly dependent on convenience foods. By providing hands-on workshops, the farm empowers citizens to reclaim control over their nutrition. Participants are taught the process from soil to table, fostering a deeper appreciation for produce. Experts argue that such movements are vital to strengthen community bonds. Ultimately, the success of this initiative demonstrates the power of education.",
                    vocab: [
                        { w: "sustainability", pos: "n.", cn: "å¯æŒçºŒæ€§" },
                        { w: "hands-on", pos: "adj.", cn: "å¯¦è¸çš„" },
                        { w: "appreciation", pos: "n.", cn: "è³è­˜/æ„Ÿæ¿€" },
                        { w: "strengthen", pos: "v.", cn: "åŠ å¼·" },
                        { w: "success", pos: "n.", cn: "æˆåŠŸ" }
                    ]
                }
            ]
        }
    ];

    // --- å…¨å±€è®Šæ•¸ ---
    let studentID = localStorage.getItem('dse_student_id') || 'unknown';
    let activeArt = null;
    let quizPool = [];
    let quizIdx = 0;
    let score = 0;
    let isAnswering = false;

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', initHome);

    function initHome() {
        // é¡¯ç¤ºå­¸ç”Ÿåå­—
        const badge = document.getElementById('student-display');
        if (studentID === 'unknown') {
            badge.innerText = "âš ï¸ èº«ä»½æœªè¨­å®š (é»æ“Šä¿®æ”¹)";
            badge.style.background = "#ffd700";
        } else {
            badge.innerText = `ğŸ‘¤ ${studentID}`;
            badge.style.background = "#eee";
        }

        // æ¸²æŸ“æ‘ºç–Šå¼åˆ—è¡¨
        const container = document.getElementById('news-container');
        container.innerHTML = '';

        newsGroups.forEach((group, idx) => {
            // 1. æ¨™é¡Œåˆ—
            const header = document.createElement('div');
            header.className = 'group-header';
            header.innerHTML = `ğŸ“… ${group.topic}`;
            header.onclick = () => toggleGroup(idx);

            // 2. å…§å®¹å®¹å™¨ (é è¨­éš±è—)
            const contentDiv = document.createElement('div');
            contentDiv.id = `group-${idx}`;
            contentDiv.className = 'group-content';

            group.levels.forEach(lv => {
                const isDone = localStorage.getItem('dse_vocab_' + lv.id) === 'done';
                const card = document.createElement('div');
                card.className = `level-card ${isDone ? 'done' : ''}`;
                card.onclick = () => loadLevel(lv);
                card.innerHTML = `
                    <div style="font-weight:bold; color:var(--primary);">${lv.level}</div>
                    <div style="font-size:1.2rem;">${isDone ? 'âœ…' : 'ğŸ‘‰'}</div>
                `;
                contentDiv.appendChild(card);
            });

            const wrapper = document.createElement('div');
            wrapper.className = 'news-group';
            wrapper.appendChild(header);
            wrapper.appendChild(contentDiv);
            container.appendChild(wrapper);
        });
    }

    // æ‘ºç–Šé–‹é—œé‚è¼¯
    function toggleGroup(idx) {
        const content = document.getElementById(`group-${idx}`);
        const allContents = document.querySelectorAll('.group-content');
        const allHeaders = document.querySelectorAll('.group-header');
        
        // å¦‚æœé»æ“Šå·²æ‰“é–‹çš„ï¼Œå‰‡é—œé–‰å®ƒ
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            allHeaders[idx].classList.remove('active');
        } else {
            // é—œé–‰å…¶ä»–æ‰€æœ‰
            allContents.forEach(c => c.classList.remove('show'));
            allHeaders.forEach(h => h.classList.remove('active'));
            // æ‰“é–‹ç•¶å‰
            content.classList.add('show');
            allHeaders[idx].classList.add('active');
        }
    }

    // --- é€²å…¥å­¸ç¿’æ¨¡å¼ (æ–‡ç« ç½®é ‚ + Highlight) ---
    function loadLevel(levelData) {
        activeArt = levelData;
        toggleScreen('study-screen');
        document.getElementById('nav-title').innerText = levelData.level;

        // 1. è™•ç†æ–‡ç«  Highlight
        const articleBox = document.getElementById('article-display');
        let htmlContent = activeArt.content;

        // å°‡æ¯å€‹å–®å­—æ›¿æ›ç‚ºå¸¶æœ‰ onclick çš„ span
        activeArt.vocab.forEach(v => {
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼é€²è¡Œå…¨å­—åŒ¹é… (Case insensitive)
            const regex = new RegExp(`\\b(${v.w})\\b`, 'gi');
            htmlContent = htmlContent.replace(regex, `<span class="highlight-word" onclick="speak('$1')">$1</span>`);
        });
        articleBox.innerHTML = htmlContent;

        // 2. æ¸²æŸ“ä¸‹æ–¹å–®å­—è¡¨
        const listDiv = document.getElementById('vocab-list');
        listDiv.innerHTML = activeArt.vocab.map(v => `
            <div class="word-card">
                <div style="font-weight:bold; font-size:1.2rem; color:var(--primary);">${v.w} <span style="font-size:0.9rem; color:#666;">(${v.pos})</span></div>
                <div>${v.cn}</div>
                <button onclick="speak('${v.w}')" style="margin-top:5px; border:1px solid #ccc; background:#fff; cursor:pointer; padding:2px 8px; border-radius:4px;">ğŸ”Š ç™¼éŸ³</button>
            </div>
        `).join('');

        // ç¢ºä¿é¡¯ç¤ºå­¸ç¿’å€ï¼Œéš±è—æ¸¬é©—å€
        document.getElementById('study-mode-content').classList.remove('hidden');
        document.getElementById('quiz-mode-content').classList.add('hidden');
    }

    // --- æ¸¬é©—é‚è¼¯ ---
    function startQuiz() {
        if (studentID === 'unknown') {
            alert("è«‹å…ˆè¨­å®šåå­—ï¼");
            goHome();
            return;
        }

        // åˆ‡æ›é¡¯ç¤ºï¼šéš±è—å–®å­—è¡¨ï¼Œé¡¯ç¤ºæ¸¬é©—é¡Œ
        document.getElementById('study-mode-content').classList.add('hidden');
        document.getElementById('quiz-mode-content').classList.remove('hidden');

        // åˆå§‹åŒ–é¡Œç›®
        quizPool = shuffle([...activeArt.vocab]); // ç°¡å–®éš¨æ©Ÿå…¨æ¸¬
        quizIdx = 0;
        score = 0;
        renderQuiz();
    }

    function renderQuiz() {
        isAnswering = true;
        const q = quizPool[quizIdx];
        
        document.getElementById('quiz-progress').innerText = `Q ${quizIdx + 1}/${quizPool.length}`;
        document.getElementById('quiz-score').innerText = `Score: ${score}`;
        document.getElementById('quiz-question').innerText = q.w;
        document.getElementById('feedback-msg').innerText = "";

        // ç”Ÿæˆé¸é …
        let options = [q];
        let others = activeArt.vocab.filter(v => v.w !== q.w);
        options = options.concat(shuffle(others).slice(0, 3));
        options = shuffle(options);

        const optContainer = document.getElementById('quiz-options');
        optContainer.innerHTML = '';
        
        options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.innerText = opt.cn;
            btn.onclick = () => checkAnswer(opt, q, btn);
            optContainer.appendChild(btn);
        });
    }

    function checkAnswer(selected, correct, btn) {
        if (!isAnswering) return;
        isAnswering = false;

        if (selected.w === correct.w) {
            score++;
            btn.classList.add('correct');
            document.getElementById('feedback-msg').innerText = "âœ… Correct!";
            document.getElementById('feedback-msg').style.color = "green";
            speak(correct.w); // ç­”å°è‡ªå‹•ç™¼éŸ³
        } else {
            btn.classList.add('wrong');
            document.getElementById('feedback-msg').innerText = "âŒ Wrong!";
            document.getElementById('feedback-msg').style.color = "red";
        }
        
        document.getElementById('quiz-score').innerText = `Score: ${score}`;
        setTimeout(nextStep, 1500);
    }

    function nextStep() {
        quizIdx++;
        if (quizIdx < quizPool.length) {
            renderQuiz();
        } else {
            finishQuiz();
        }
    }

    function finishQuiz() {
        toggleScreen('result-screen');
        document.getElementById('final-score').innerText = `${score} / ${quizPool.length}`;
        uploadResult(); // è‡ªå‹•åŒæ­¥
    }

    // --- åŒæ­¥èˆ‡åŠŸèƒ½ ---
    function uploadResult() {
        const status = document.getElementById('upload-status');
        if (!SCRIPT_URL || SCRIPT_URL.includes("åœ¨æ­¤å¡«å…¥")) return;

        const data = { name: studentID, topic: activeArt.id, score: score };
        
        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
        .then(() => { status.innerText = "âœ… æˆç¸¾å·²åŒæ­¥"; status.style.color = "green"; })
        .catch(e => { status.innerText = "âŒ åŒæ­¥å¤±æ•—"; });

        if (score >= 3) localStorage.setItem('dse_vocab_' + activeArt.id, "done");
    }

    // --- å·¥å…·èˆ‡ä»‹é¢ ---
    function toggleScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('nav-bar').classList.toggle('hidden', id === 'home-screen');
    }

    function editName() {
        const n = prompt("è¼¸å…¥ä½ çš„åå­—:", studentID === 'unknown' ? '' : studentID);
        if (n) { studentID = n; localStorage.setItem('dse_student_id', n); initHome(); }
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-GB';
        window.speechSynthesis.speak(u);
    }

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
    function goHome() { toggleScreen('home-screen'); initHome(); }

    // æ’è¡Œæ¦œ Modal æ§åˆ¶
    function openLeaderboard() {
        document.getElementById('leaderboard-modal').classList.remove('hidden');
        document.getElementById('lb-frame').src = LEADERBOARD_URL;
        document.getElementById('lb-link').href = LEADERBOARD_URL;
    }
    function closeLeaderboard() {
        document.getElementById('leaderboard-modal').classList.add('hidden');
    }

</script>
</body>
</html>
