<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE è‹±æ–‡è©å½™æŒ‘æˆ° V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --primary-light: #eef2ff; --success: #22c55e; --danger: #ef4444; --text: #374151; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #f3f4f6; display: flex; justify-content: center; padding: 20px; color: var(--text); }
        .container { width: 100%; max-width: 550px; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        .subtitle { text-align: center; color: #6b7280; margin-bottom: 25px; font-size: 0.9rem; }
        .btn { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid transparent; border-radius: 12px; cursor: pointer; font-size: 16px; background: var(--primary-light); color: var(--primary); font-weight: 600; transition: all 0.2s; text-align: left; display: flex; align-items: center; }
        .btn:hover { background: #e0e7ff; transform: translateY(-2px); }
        .btn-icon { margin-right: 10px; font-size: 1.2rem; }
        .option-btn { background: white; border: 1px solid #d1d5db; color: var(--text); font-weight: normal; }
        .option-btn:hover { background: #f9fafb; border-color: var(--primary); }
        .correct { background: #dcfce7 !important; border-color: var(--success) !important; color: #166534 !important; }
        .wrong { background: #fee2e2 !important; border-color: var(--danger) !important; color: #991b1b !important; }
        .hidden { display: none; }
        
        /* å­¸ç¿’æ¨¡å¼æ¨£å¼ */
        .vocab-card { border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .vocab-word { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        .vocab-pos { color: #6b7280; font-size: 0.9rem; font-style: italic; }
        
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container { background: #e5e7eb; border-radius: 10px; height: 8px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { text-align: center; font-size: 0.9rem; color: #6b7280; }
        
        /* åé¥‹å€æ¨£å¼ */
        .feedback-box { background: var(--primary-light); padding: 20px; border-radius: 15px; margin-top: 20px; display: none; }
        .feedback-box.show { display: block; animation: fadeIn 0.3s ease; }
        .fb-title { font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; }
        .fb-pos { margin-left: 5px; font-size: 0.9rem; color: #6b7280; font-style: italic; }
        .fb-def { margin-bottom: 10px; }
        .fb-example { font-style: italic; color: #4b5563; background: white; padding: 10px; border-radius: 8px; border-left: 3px solid var(--primary); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <div id="setup-screen">
        <h2>DSE è©å½™æŒ‘æˆ°ç«™</h2>
        <p class="subtitle">æ¯æ—¥ä¸€ç¯‡ News in Levelsï¼Œè¼•é¬†æå‡è©å½™é‡</p>
        <p style="font-weight: bold; margin-bottom: 15px;">è«‹é¸æ“‡ä»Šæ—¥èª²é¡Œï¼š</p>
        <div id="article-list"></div>
    </div>

    <div id="study-screen" class="hidden">
        <h2>ğŸ“ è©å½™é ç¿’ (Word Bank)</h2>
        <p class="subtitle">å…ˆå­¸ç¿’ä»¥ä¸‹å–®å­—ï¼Œæº–å‚™å¥½å¾Œé–‹å§‹æŒ‘æˆ°ï¼</p>
        <div id="study-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
        <button class="btn" style="background: var(--primary); color: white; text-align: center; justify-content: center;" onclick="startQuiz()">
            <span class="btn-icon">ğŸš€</span> æˆ‘æº–å‚™å¥½äº†ï¼Œé–‹å§‹æŒ‘æˆ°ï¼
        </button>
    </div>

    <div id="quiz-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 id="quiz-title" style="margin: 0; font-size: 1rem; color: var(--primary);"></h3>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
        <p class="progress-text" id="progress-text"></p>
        
        <h2 id="word-display" style="font-size: 2.5rem; margin: 20px 0; text-align: center;"></h2>
        <p style="text-align: center; color: #6b7280; margin-bottom: 20px;">è«‹é¸æ“‡æœ€åˆé©çš„è§£é‡‹ï¼š</p>
        <div id="options-box"></div>

        <div id="feedback-box" class="feedback-box">
            <div class="fb-title" id="fb-title"></div>
            <div class="fb-def" id="fb-def"></div>
            <div class="fb-example" id="fb-example"></div>
            <button class="btn" id="next-btn" style="margin-top: 15px; background: var(--primary); color: white; text-align: center; justify-content: center;" onclick="nextQuestion()">
                ä¸‹ä¸€é¡Œ <span class="btn-icon" style="margin-left: 5px;">ğŸ‘‰</span>
            </button>
        </div>
    </div>

    <div id="result-screen" class="hidden" style="text-align: center; padding: 20px 0;">
        <div style="font-size: 4rem;">ğŸ‰</div>
        <h2 style="color: var(--success); margin: 10px 0;">æŒ‘æˆ°æˆåŠŸï¼</h2>
        <p>ä½ å·²æŒæ¡äº†æœ¬ç¯‡æ–‡ç« çš„é‡é»è©å½™ã€‚</p>
        <p style="color: #6b7280; margin-bottom: 20px;">(è¨˜å¾—æˆªåœ–å‚³çµ¦è€å¸«ä½œç‚ºç´€éŒ„å“¦ï¼)</p>
        <button class="btn" style="background: var(--primary); color: white; text-align: center; justify-content: center;" onclick="location.reload()">
            <span class="btn-icon">ğŸ </span> å›åˆ°ä¸»é 
        </button>
    </div>
</div>

<script>
/* ==================================================================
   è€å¸«æ›´æ–°å€ (V2.0 æ ¼å¼)ï¼šè«‹è¤‡è£½æˆ‘æä¾›çš„å®Œæ•´è³‡æ–™å¡Šæ›¿æ›é€™è£¡
   ================================================================== */
const newsData = [
    {
        title: "Storm Goretti Hits Europe",
        level: 1,
        levelLabel: "åŸºç¤ (Level 1)",
        vocab: [
            { w: "storm", pos: "n.", d: "very bad weather with strong wind and rain", chinese: "é¢¨æš´", example: "The storm caused a lot of damage to the small town." },
            { w: "power", pos: "n.", d: "electricity", chinese: "é›»åŠ›", example: "The storm cut off power to thousands of homes." },
            { w: "hit", pos: "v.", d: "to come to a place with force", chinese: "ä¾µè¥² / æ‰“æ“Š", example: "The hurricane is expected to hit the coast tomorrow." },
            { w: "flight", pos: "n.", d: "a journey in a plane", chinese: "èˆªç­ / é£›è¡Œ", example: "Their flight to London was cancelled due to bad weather." },
            { w: "dangerous", pos: "adj.", d: "not safe", chinese: "å±éšªçš„", example: "It is dangerous to drive in such heavy rain." }
        ]
    },
    {
        title: "Storm Goretti Hits Europe",
        level: 2,
        levelLabel: "ä¸­ç­‰ (Level 2)",
        vocab: [
            { w: "disrupt", pos: "v.", d: "to stop something from happening normally", chinese: "æ“¾äº‚ / ä¸­æ–·", example: "The strike will disrupt train services across the country." },
            { w: "gust", pos: "n.", d: "a sudden strong wind", chinese: "é™£é¢¨", example: "A sudden gust of wind blew his hat off." },
            { w: "cancel", pos: "v.", d: "to stop a planned event", chinese: "å–æ¶ˆ", example: "They had to cancel the meeting because the boss was ill." },
            { w: "severe", pos: "adj.", d: "very bad or serious", chinese: "åš´é‡çš„", example: "The patient is in severe pain." },
            { w: "damage", pos: "v.", d: "to break something or make it bad", chinese: "æå®³ / ç ´å£", example: "Smoking can seriously damage your health." }
        ]
    },
    {
        title: "Storm Goretti Hits Europe",
        level: 3,
        levelLabel: "é€²éš (Level 3)",
        vocab: [
            { w: "wreak havoc", pos: "phr.", d: "to cause a lot of trouble or damage", chinese: "é€ æˆåš´é‡ç ´å£", example: "The virus wreaked havoc on the computer system." },
            { w: "unprecedented", pos: "adj.", d: "never happened before", chinese: "å²ç„¡å‰ä¾‹çš„", example: "The team's success is unprecedented in the history of the sport." },
            { w: "infrastructure", pos: "n.", d: "basic systems like roads or power", chinese: "åŸºç¤å»ºè¨­", example: "The country needs to invest more in its aging infrastructure." },
            { w: "meteorological", pos: "adj.", d: "related to the weather", chinese: "æ°£è±¡çš„", example: "Accurate meteorological data is crucial for predicting storms." },
            { w: "verify", pos: "v.", d: "to check if something is true", chinese: "æ ¸å¯¦ / é©—è­‰", example: "Please verify your account by clicking the link in the email." }
        ]
    }
];

/* ==========================================
   ç¨‹å¼é‚è¼¯å€ï¼šè«‹å‹¿æ›´å‹•
   ========================================== */
let currentArticle = null;
let currentPool = [];
let wrongFromLastRound = [];
let currentIndex = 0;
let isRetryRound = false;

// åˆå§‹åŒ–ï¼šç”Ÿæˆé¦–é æ–‡ç« åˆ—è¡¨
const articleList = document.getElementById('article-list');
newsData.forEach((item, index) => {
    const btn = document.createElement('button');
    btn.className = 'btn';
    // ä½¿ç”¨ Emoji å’Œä¸­æ–‡æ¨™ç±¤
    let icon = item.level === 1 ? 'ğŸŒ±' : item.level === 2 ? 'ğŸŒ¿' : 'ğŸŒ³';
    btn.innerHTML = `<span class="btn-icon">${icon}</span> <div><strong>${item.levelLabel}</strong><br><span style="font-size: 0.9rem; font-weight: normal;">${item.title}</span></div>`;
    btn.onclick = () => showStudyScreen(index);
    articleList.appendChild(btn);
});

function showStudyScreen(index) {
    currentArticle = newsData[index];
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('study-screen').classList.remove('hidden');
    
    const studyList = document.getElementById('study-list');
    studyList.innerHTML = '';
    currentArticle.vocab.forEach(v => {
        const card = document.createElement('div');
        card.className = 'vocab-card';
        // é¡¯ç¤ºå–®å­—ã€è©æ€§å’Œä¸­æ–‡
        card.innerHTML = `<span class="vocab-word">${v.w}</span> <span class="vocab-pos">(${v.pos} ${v.chinese})</span><br><span style="font-size: 0.9rem;">${v.d.split('/')[0]}</span>`;
        studyList.appendChild(card);
    });
}

function startQuiz() {
    document.getElementById('study-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    document.getElementById('quiz-title').innerText = `${currentArticle.title} - ${currentArticle.levelLabel}`;
    
    // ç¬¬ä¸€è¼ªï¼šéš¨æ©Ÿé¸5é¡Œ (å¦‚æœä¸è¶³5é¡Œå‰‡å…¨é¸)
    let initialPool = shuffle([...currentArticle.vocab]);
    startNewRound(initialPool.slice(0, 5));
}

function startNewRound(words) {
    currentPool = words;
    wrongFromLastRound = [];
    currentIndex = 0;
    updateProgress();
    showQuestion();
}

function updateProgress() {
    let total = currentPool.length;
    let current = currentIndex + 1;
    let percent = (currentIndex / total) * 100;
    document.getElementById('progress-bar').style.width = `${percent}%`;
    document.getElementById('progress-text').innerText = isRetryRound ? `ğŸ”¥ éŒ¯é¡Œé‡æº«ï¼šç¬¬ ${current} / ${total} é¡Œ` : `é€²åº¦ï¼šç¬¬ ${current} / ${total} é¡Œ`;
}

function showQuestion() {
    if (currentIndex >= currentPool.length) {
        checkRoundEnd();
        return;
    }
    updateProgress();
    document.getElementById('feedback-box').classList.remove('show');
    
    const currentQ = currentPool[currentIndex];
    document.getElementById('word-display').innerText = currentQ.w;
    
    const optionsBox = document.getElementById('options-box');
    optionsBox.innerHTML = "";

    // ç”Ÿæˆé¸é …ï¼š1æ­£ + 3èª¤
    let options = [currentQ];
    let distractors = currentArticle.vocab.filter(v => v.w !== currentQ.w);
    options.push(...shuffle(distractors).slice(0, 3));
    options = shuffle(options);

    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'btn option-btn';
        btn.innerText = opt.d.split('/')[0].trim(); // åªé¡¯ç¤ºç¬¬ä¸€å€‹å®šç¾©
        btn.onclick = () => handleAnswer(btn, opt, currentQ);
        optionsBox.appendChild(btn);
    });
}

function handleAnswer(selectedBtn, selectedOpt, correctQ) {
    disableButtons();
    const feedbackBox = document.getElementById('feedback-box');
    const fbTitle = document.getElementById('fb-title');
    
    let isCorrect = selectedOpt.w === correctQ.w;
    
    if (isCorrect) {
        selectedBtn.classList.add('correct');
        fbTitle.innerHTML = `<span style="color: var(--success);">âœ… Correct! ç­”å°äº†ï¼</span>`;
    } else {
        selectedBtn.classList.add('wrong');
        fbTitle.innerHTML = `<span style="color: var(--danger);">âŒ Keep trying! åŠ æ²¹ï¼</span>`;
        // æ¨™ç¤ºå‡ºæ­£ç¢ºç­”æ¡ˆçš„æŒ‰éˆ•
        document.querySelectorAll('.option-btn').forEach(btn => {
            if (btn.innerText === correctQ.d.split('/')[0].trim()) {
                btn.classList.add('correct');
            }
        });
        if (!wrongFromLastRound.find(x => x.w === correctQ.w)) {
            wrongFromLastRound.push(correctQ);
        }
    }
    
    // é¡¯ç¤ºè©³ç´°è§£é‡‹
    document.getElementById('fb-title').innerHTML += `<span class="fb-pos">(${correctQ.pos} ${correctQ.chinese})</span>`;
    document.getElementById('fb-def').innerText = correctQ.d;
    // å¦‚æœæœ‰ä¾‹å¥å‰‡é¡¯ç¤º
    if (correctQ.example) {
         // å°‡ä¾‹å¥ä¸­çš„ç›®æ¨™å–®å­—åŠ ç²—
        let highlightedEx = correctQ.example.replace(new RegExp(correctQ.w, 'gi'), match => `<strong>${match}</strong>`);
        document.getElementById('fb-example').innerHTML = `Example: "${highlightedEx}"`;
        document.getElementById('fb-example').classList.remove('hidden');
    } else {
        document.getElementById('fb-example').classList.add('hidden');
    }

    feedbackBox.classList.add('show');
    // è‡ªå‹•æ»¾å‹•åˆ°åé¥‹å€
    feedbackBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function nextQuestion() {
    currentIndex++;
    showQuestion();
}

function disableButtons() {
    document.querySelectorAll('.option-btn').forEach(b => b.style.pointerEvents = 'none');
}

function checkRoundEnd() {
    if (wrongFromLastRound.length === 0) {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
    } else {
        isRetryRound = true;
        // æº–å‚™ä¸‹ä¸€è¼ªï¼šéŒ¯é¡Œå„ªå…ˆï¼Œè‹¥ä¸è¶³5é¡Œå‰‡å¾æœªè€ƒéçš„å­—ä¸­è£œå……
        let nextRound = [...wrongFromLastRound];
        let handledWords = currentPool.map(w => w.w); // é€™ä¸€è¼ªè€ƒéçš„å­—
        let remaining = currentArticle.vocab.filter(v => !handledWords.includes(v.w));
        
        while (nextRound.length < 5 && remaining.length > 0) {
            nextRound.push(remaining.pop());
        }
        
        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        const container = document.getElementById('main-container');
        const alertMsg = document.createElement('div');
        alertMsg.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:15px 25px; border-radius:30px; z-index:1000; animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards;";
        alertMsg.innerHTML = `æœ¬è¼ªçµæŸï¼æœ‰ ${wrongFromLastRound.length} é¡Œéœ€è¦è¤‡ç¿’ ğŸ’ª`;
        document.body.appendChild(alertMsg);
        setTimeout(() => alertMsg.remove(), 3000);

        startNewRound(nextRound);
    }
}

function shuffle(array) {
    return array.sort(() => Math.random() - 0.5);
}
</script>
</body>
</html>
